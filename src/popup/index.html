<html>
    <head>
        <meta charset="UTF-8"/>
        <link rel="stylesheet" type="text/css" href="./popup.css">
    </head>
    <body 
        class="w-64 bg-bkg-1"
        x-data="{
            page: 'home',
            tokensInfo:[],
            toggles: {}
        }"
        x-init="chrome.storage.local.get(
            ['tokensInfo', 'toggles'], 
            result => {
                console.log(
                    `got from storage ${JSON.stringify(result)}`
                )
                tokensInfo = result.tokensInfo
                if (result.toggles) {
                        toggles = result.toggles
                } else {
                    tokensInfo.forEach((token) => {
                        toggles[token.name] = true
                    })
                }
                
                if (Object.keys(toggles).length !== tokensInfo.length) {
                    tokensInfo.forEach((token) => {
                        if (toggles[token.name] === undefined) {
                            toggles[token.name] = true
                        }
                    })
                }

            }
        )
        chrome.runtime.onMessage.addListener(
            function(request, sender, sendResponse) {
                console.log(`received message ${request.msg}` )
                if (request.msg === 'tokensInfo updated') {
                    tokensInfo = request.data.content
                }
            }
        )
        "
    >        <!-- add onChange to track chrome storage object and update DOM -->
        <div class="justify-between p-4">
            <div class="overflow-y-auto" style="min-height: 220px">
                <div x-show="page == 'home'">
                    <header class="flex justify-center pb-2 mx-auto text-base font-medium text-orange-default">
                        <img src="./icons/logo.svg" height="24" width="24" class="mr-1">
                        <span>Mango Markets Watch</span>
                    </header>
                    <div class="flex min-w-full p-1 rounded-lg bg-bkg-2">
                        <table class="flex-col flex-grow mx-auto table-auto">
                            <thead class="bg-bkg-2">
                                <tr class="mb-2 text-xs text-center text-fgd-4">
                                <th class="flex-auto px-2 font-normal text-left">Token</th>
                                <th class="flex-auto px-2 font-normal text-right">Deposit</th>
                                <th class="flex-auto font-normal text-right">/</th>
                                <th class="flex-auto pr-2 font-normal text-right">Borrow</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="token in tokensInfo">
                                    <tr x-show="toggles[token.name]">
                                        <td class="flex items-end flex-auto px-2 text-left text-fgd-1" >
                                            <!-- <img :src="token.icon" width="18"
                                            height="18" class='mr-1'> -->
                                            <span x-text="token.name"></span>
                                        </td>
                                        <td class="flex-auto px-2 text-right text-green-dark">
                                            <span x-text="token.depositRate"></span>
                                            <span>%</span>
                                        </td>
                                        <td class="flex-auto font-normal text-right text-fgd-2">/</td>
                                        <td class="flex-auto pr-2 text-right text-red-dark">
                                            <span x-text="token.borrowRate"></span>
                                            <span>%</span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div x-show="page == 'settings'">
                    <header class="flex justify-center pb-2 mx-auto text-base font-medium text-orange-default">
                        Token Settings
                    </header>
                    <div class="text-sm rounded-lg bg-bkg-2">
                        <table class="flex-col flex-grow mx-auto text-sm table-auto">
                            <template x-for="token in tokensInfo" :key="token">
                                <tr class="flex flex-row pb-1">
                                    <td 
                                        class="flex items-end flex-auto px-2 text-left text-fgd-1" 
                                        x-text="token.name">
                                    </td>
                                    <td class="flex items-center justify-center ml-12">
                                        <div 
                                            class="relative w-10 h-5 transition duration-200 ease-linear rounded-full"
                                            :class="[toggles[token.name] === true ? 'bg-green-dark' : 'bg-fgd-4']"
                                        >
                                            <label 
                                                :for="token.name" 
                                                class="absolute left-0 w-5 h-5 mb-2 transition duration-100 ease-linear transform bg-white border-2 rounded-full"
                                                :class="[toggles[token.name] === true ? 'translate-x-full border-green-dark' : 'translate-x-0 border-fgd-4']">
                                            </label>
                                            <input 
                                                type="checkbox" 
                                                :id="token.name" 
                                                :name="token.name" 
                                                class="w-full h-full appearance-none cursor-pointer active:outline-none focus:outline-none"
                                                @click="
                                                toggles[token.name] = ! toggles[token.name];
                                                chrome.storage.local.set({toggles: toggles}, () => {console.log(`setting storage toggles: ${JSON.stringify(toggles)}`)})
                                                "
                                            >
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>
                <div x-show="page == 'alert'">
                    <header class="flex justify-center pb-2 mx-auto text-base font-medium text-orange-default">Alerts</header>
                    <div class="py-6 text-center rounded-lg text-fgd-2 bg-bkg-2">Coming Soon</div>
                    <!-- alerts for when interest rates pass a threshold? -->
                    <!-- or liquidation alerts? -->
                </div>
            </div>
            <div class="flex flex-row items-end justify-around pt-4 bg-bkg-1 text-fgd-4">
                <div class="flex text-center">
                    <button x-on:click="page = 'settings'">
                        <img src="./icons/settings.svg" width="24" height="24">
                    </button>
                </div>
                <div class="flex text-center">
                    <button x-on:click="page = 'home'">
                        <img src="./icons/home.svg" width="24" height="24">
                    </button>
                </div>
                <div class="flex text-center">
                    <button x-on:click="page = 'alert'">
                    <img src="./icons/alert.svg" width="24" height="24">
                </button>
                </div>
            </div>
        </div>
        <script type="text/javascript" src="./popup.dist.js"></script>
    </body>
</html>


